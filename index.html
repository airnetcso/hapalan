<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TEST KOSA KATA</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: url('https://raw.githubusercontent.com/airnetcso/eps/main/image/bg1.jpg') no-repeat center center fixed;
      background-size: cover;
      position: relative;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 0;
    }

    /* ================= SPLASH PREMIUM ================= */
    #splash {
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(0,0,0,0.82), rgba(0,0,0,0.82)),
        url("https://raw.githubusercontent.com/airnetcso/eps/main/image/bg1.jpg")
        center/cover no-repeat;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 40px;
      z-index: 9999;
      text-align: center;
      transition: opacity 1.3s ease;
      animation: fadeIn 1.2s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .splash-box {
      max-width: 560px;
      width: 100%;
      transform: translateY(10px);
    }
    #splash h1 {
      font-size: 22px;
      font-weight: 800;
      line-height: 1.4;
      margin-bottom: 20px;
      text-shadow: 0 4px 12px rgba(0,0,0,0.9), 0 0 20px rgba(255, 107, 157, 0.4);
      letter-spacing: 0.5px;
    }
    #splash h1 b {
      color: #ff6b9d;
    }
    #splash-names {
      font-size: 11px;
      line-height: 1.7;
      opacity: 0.92;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.7);
      max-width: 90%;
      margin: 0 auto;
    }
    #splash-names span {
      white-space: normal;
    }
    #splash-names span::after {
      content: ". ";
      opacity: 0.7;
    }
    #splash-names span:last-child::after {
      content: " ðŸ”¥";
    }
    @media (max-width: 480px) {
      #splash {
        padding: 40px 30px;
      }
      #splash-names {
        font-size: 10px;
      }
    }

    /* Animasi (kode asli) */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes pulseWrong { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* Container (persis seperti /eps: ramping 260px) */
    .container {
      position: relative; z-index: 2;
      width: 90%;
      max-width: 260px;
      padding: 30px 20px;
      border-radius: 12px;
      background: rgba(40,40,40,0.9);
      border: 1px solid #555;
      box-shadow: 0 12px 28px rgba(0,0,0,0.65);
      animation: fadeIn 0.9s ease-out;
    }

    h1 {
      font-size: 26px;
      text-align: center;
      margin: 0 0 18px;
      color: #f0f0f0;
      font-weight: 600;
      letter-spacing: 1px;
    }

    input[type="text"] {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #222;
      color: #e0e0e0;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input::placeholder { color: #888; opacity:1; }
    input:focus { border-color: #6b7280; outline: none; }

    button {
      width: 100%;
      padding: 14px;
      margin: 14px 0 8px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      background: #2563eb;
      transition: background 0.3s ease;
    }
    button:hover { background: #1d4ed8; }
    button:active { background: #1e40af; }

    .hidden { display: none !important; }

    #timer { text-align: center; font-size: 32px; font-weight: bold; margin: 20px 0; padding: 12px; background: rgba(220,38,38,0.2); border-radius:6px; }
    #timer.warning { background: rgba(249,115,22,0.3); color: #fed7aa; }

    .progress { height: 12px; background: #333; border-radius: 6px; margin: 16px 0; overflow: hidden; }
    .progress-bar { height: 100%; background: #1e40af; width: 0%; transition: width 0.8s ease; }

    #questionNumber { text-align: center; font-size: 18px; margin: 12px 0; color: #bbb; }

    .question strong { font-size: 44px; display: block; margin: 28px 0 28px; color: #f0f0f0; text-align: center; font-weight: 700; }

    #feedback { text-align: center; font-size: 26px; font-weight: bold; margin: 20px 0; height: 36px; }
    .correct { color: #86efac; animation: pulseCorrect 0.6s; }
    .wrong { color: #fca5a5; animation: pulseWrong 0.6s; }

    .wrong-list { font-size: 16px; line-height: 1.8; margin: 24px 0; background: rgba(254,226,226,0.9); color: #991b1b; padding: 20px; border-left: 5px solid #ef4444; border-radius:6px; }

    .footer { position: relative; z-index: 2; margin-top: 36px; font-size: 13px; color: #aaa; text-align: center; }
  </style>
</head>
<body>

<!-- SPLASH PREMIUM -->
<div id="splash">
  <div class="splash-box">
    <h1>
      <b>ì—¬ëŸ¬ë¶„,</b> tetap semangat!<br>
      Kalian semua pasti lulus EPS TOPIK, Aamiin ...
    </h1>
    <div id="splash-names">
      Uus. Hanarizka. Windi. Rismayayanti. Sita. Mila. Aini. Feinie. Hamdan. Heri. Fikrisurya. Mutiara. Wantika. Dini. Kaniarostayuni. Dikisetiawan. Aisyah. Rizka. Dinda. Zhafif. Siwon. Azizah. Yppsdi. Satria. Sultan. Aditya. Bima. Citra. Dewi. Eka. Fadli. Gita. Hafiz. Indah. Jihan. Kim Jihoon. Laras. Minji. Naufal. Putri. Qori. Raka. Sari. Taufik. Umair. Vina. Wahyu. Xena. Yanti. Zara. Arif. Bunga. Chandra. Dhani. Elina. Fajar. Galang. Hadi. Indra. Joko. Kurnia. Lukman. Maulana. Nanda ðŸ”¥
    </div>
  </div>
</div>

<!-- Login Page (awalnya disembunyikan) -->
<div class="container hidden" id="loginPage">
  <h1>TEST KOSA KATA</h1>
  <input type="text" id="userId" placeholder="User ID / ì•„ì´ë””" autocomplete="off">
  <input type="text" id="kodeSoal" placeholder="Kode Soal / ì‹œí—˜ì½”ë“œ" autocomplete="off">
  <button onclick="login()">MULAI / ì‹œìž‘</button>
</div>

<!-- Quiz Page -->
<div class="container hidden" id="quizPage">
  <h1>TEST KOSA KATA</h1>
  <div id="timer">50:00</div>
  <div id="questionNumber">Soal 1 dari 50</div>
  <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  <div id="questionArea">
    <div id="feedback"></div>
    <div class="question"><strong id="currentWord"></strong></div>
    <input type="text" id="answerInput" placeholder="Ketik jawaban di sini" autocomplete="off">
    <button onclick="submitAnswer()" id="submitBtn">SUBMIT</button>
  </div>
  <div id="resultArea" class="hidden">
    <h2 style="color:#f0f0f0; margin-bottom:20px; text-align:center;">Hasil Test</h2>
    <p id="scoreText" style="font-size:32px; font-weight:bold; color:#d1d5db; text-align:center;"></p>
    <div id="wrongWords" class="wrong-list hidden"></div>
    <button onclick="restartQuiz()">ULANGI LAGI</button>
    <button onclick="backToLogin()" style="background:#374151; margin-top:10px;">KEMBALI KE LOGIN</button>
  </div>
</div>

<div class="footer">Â© 2026 Denzuka - Kim Jongun. All rights reserved.</div>

<script>
// Splash logic: 6 detik â†’ fade out mulus
document.addEventListener("DOMContentLoaded", () => {
  const splash = document.getElementById("splash");
  const loginPage = document.getElementById("loginPage");

  setTimeout(() => {
    splash.style.opacity = "0";
    setTimeout(() => {
      splash.style.display = "none";
      loginPage.classList.remove("hidden");
    }, 1300);
  }, 6000);
});

// Sisanya script tetap sama persis seperti kode asli kamu
const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbzxyVIlsyLswlfnQG618eeUZgN83dd2jfCjU0r7LsNHM3A6NNiibuCIb5e3CNs9J1vVhQ/exec";

const userIdToName = {
  "2026010001":"Uus",
  "2026010002":"Hanarizka",
  "2026010011":"Windi",
  "2026010017":"Rismayayanti",
  "2026010005":"Sita",
  "2026010006":"Mila",
  "2026010023":"Aini",
  "2026010008":"Feinie",
  "2026010009":"Hamdan",
  "2026010010":"Heri",
  "2026010031":"Fikrisurya",
  "2026010012":"Mutiara",
  "2026010043":"Wantika",
  "2026010014":"Dini",
  "2026010015":"Kaniarostayuni",
  "2026010016":"Dikisetiawan",
  "2026010064":"Aisyah",
  "2026010018":"Rizka",
  "2026010019":"Dinda",
  "2026010020":"Zhafif",
  "2026010021":"Siwon",
  "2026010022":"Azizah",
  "2026010023":"Yppsdi",
  "2026010024":"Satria",
  "2026010025":"Sultan"
};

const kodeMapping = {
  "h050126":"soal1.json",
  "sarewae":"test.json",
  "r43213":"soal2.json",
  "mugunghwa":"soal11.json",
  "kimchi":"soal12.json",
  "seoul":"soal13.json",
  "teokbokki":"soal14.json",
  "kimtaehyung":"soal15.json",
  "chuseok":"soal16.json",
  "kimbap":"soal17.json",
  "saranghae":"soal3.json"
};

let questions = [], currentIndex = 0, score = 0, wrongList = [], timerInterval, timeLeft = 3000;
let username = "", kodeSoal = "";
let attemptCount = 0;

function login() {
  const userIdInput = document.getElementById("userId").value.trim();
  kodeSoal = document.getElementById("kodeSoal").value.trim().toLowerCase();
  if (!userIdInput || !kodeSoal) { alert("Lengkapi User ID dan Kode Soal!"); return; }
  const mappedName = userIdToName[userIdInput];
  if (!mappedName) { alert("User ID tidak terdaftar! Angka yang kamu ketik: " + userIdInput); return; }
  username = mappedName;
  const fileName = kodeMapping[kodeSoal];
  if (!fileName) { alert("Kode Soal tidak valid!"); return; }
  loadQuestions(fileName).then(() => {
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("quizPage").classList.remove("hidden");
    startQuiz();
  }).catch(err => { alert("Gagal memuat soal: " + err.message); });
}

async function loadQuestions(fileName) {
  const res = await fetch(fileName);
  if (!res.ok) throw new Error("File soal tidak ditemukan");
  let data = await res.json();
  for (let i = data.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [data[i], data[j]] = [data[j], data[i]];
  }
  questions = data.slice(0, Math.min(50, data.length));
}

function startQuiz() {
  currentIndex = 0; score = 0; wrongList = []; timeLeft = 3000; attemptCount = 0;
  updateTimer(); updateQuestionNumber(); updateProgress();
  timerInterval = setInterval(() => { timeLeft--; updateTimer(); if (timeLeft <= 0) finishQuiz(); }, 1000);
  nextQuestion();
}

function updateTimer() {
  const m = String(Math.floor(timeLeft / 60)).padStart(2, "0");
  const s = String(timeLeft % 60).padStart(2, "0");
  const timerEl = document.getElementById("timer");
  timerEl.textContent = `${m}:${s}`;
  if (timeLeft <= 300) timerEl.classList.add("warning");
  else timerEl.classList.remove("warning");
}

function updateQuestionNumber() {
  document.getElementById("questionNumber").textContent = `Soal ${currentIndex + 1} dari ${questions.length}`;
}

function updateProgress() {
  const percent = (currentIndex / questions.length) * 50;
  document.getElementById("progressBar").style.width = percent + "%";
}

function nextQuestion() {
  if (currentIndex >= questions.length) { finishQuiz(); return; }
  document.getElementById("currentWord").textContent = questions[currentIndex].korea;
  document.getElementById("answerInput").value = "";
  document.getElementById("answerInput").focus();
  document.getElementById("feedback").textContent = "";
  updateQuestionNumber();
  updateProgress();
}

function submitAnswer() {
  const answer = document.getElementById("answerInput").value.trim();
  if (!answer) return;

  const feedback = document.getElementById("feedback");
  const q = questions[currentIndex];

  // Normalisasi jawaban user: lebih permisif terhadap typo
  const normalize = str => str
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')          // hilangkan tanda baca
    .replace(/\s+/g, ' ')                 // ganti spasi banyak jadi satu
    .trim();

  let normUser = normalize(answer)
    .replace(/(.)\1{2,}/g, '$1');         // hilangkan huruf duplikat beruntun (contoh: "jemmput" â†’ "jemput")

  // Normalisasi semua jawaban benar (array atau string)
  let correctAnswers = Array.isArray(q.indo)
    ? q.indo.map(a => normalize(a))
    : [normalize(q.indo)];

  // Cek exact match dulu
  let isCorrect = correctAnswers.includes(normUser);

  // Jika belum cocok, cek toleransi typo sederhana (Levenshtein distance â‰¤ 2)
  if (!isCorrect) {
    const distance = (s1, s2) => {
      const track = Array(s2.length + 1).fill(null).map(() => Array(s1.length + 1).fill(null));
      for (let i = 0; i <= s1.length; i++) track[0][i] = i;
      for (let j = 0; j <= s2.length; j++) track[j][0] = j;
      for (let j = 1; j <= s2.length; j++) {
        for (let i = 1; i <= s1.length; i++) {
          const indicator = s1[i - 1] === s2[j - 1] ? 0 : 1;
          track[j][i] = Math.min(
            track[j][i - 1] + 1,          // deletion
            track[j - 1][i] + 1,          // insertion
            track[j - 1][i - 1] + indicator // substitution
          );
        }
      }
      return track[s2.length][s1.length];
    };

    isCorrect = correctAnswers.some(correct => distance(normUser, correct) <= 2);
  }

  if (isCorrect) {
    attemptCount = 0;
    score++;
    feedback.textContent = "Benar!";
    feedback.className = "correct";
    setTimeout(() => { currentIndex++; nextQuestion(); }, 800);
  } else {
    attemptCount++;
    if (attemptCount >= 3) {
      wrongList.push({ word: q.korea, correct: Array.isArray(q.indo) ? q.indo.join(" / ") : q.indo, your: answer });
      feedback.textContent = `Salah! â†’ ${Array.isArray(q.indo) ? q.indo.join(" / ") : q.indo}`;
      feedback.className = "wrong";
      setTimeout(() => { attemptCount = 0; currentIndex++; nextQuestion(); }, 1500);
    } else {
      feedback.textContent = "Salah!";
      feedback.className = "wrong";
      document.getElementById("answerInput").value = "";
      document.getElementById("answerInput").focus();
    }
  }
}

function finishQuiz() {
  clearInterval(timerInterval);
  document.getElementById("questionArea").classList.add("hidden");
  document.getElementById("resultArea").classList.remove("hidden");
  const totalQuestions = questions.length;
  const percent = Math.round((score / totalQuestions) * 50);
  document.getElementById("scoreText").textContent = `Skor: ${score}/${totalQuestions} (${percent}%)`;
  const wrongDiv = document.getElementById("wrongWords");
  wrongDiv.innerHTML = "";
  let keterangan = "";
  if (wrongList.length > 0) {
    wrongDiv.classList.remove("hidden");
    wrongDiv.innerHTML = "<strong>Kata yang salah:</strong><br><br>";
    wrongList.forEach(i => {
      wrongDiv.innerHTML += `â€¢ <strong>${i.word}</strong> â†’ ${i.correct} <br><small style="color:#78350f;">(jawaban kamu: ${i.your})</small><br><br>`;
    });
    keterangan = wrongList.map(i => `${i.word} â†’ ${i.your} (benar: ${i.correct})`).join(" | ");
  } else {
    keterangan = "Semua benar! Perfect!";
  }
  const dataToSend = {
    waktu: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
    namaSiswa: username || "Anonymous",
    code: kodeSoal || "Unknown",
    kosaKata: `${score}/${totalQuestions} (${percent}%)`,
    ubt: "-",
    latihanSoal: totalQuestions,
    keterangan: keterangan
  };
  const formData = new URLSearchParams(dataToSend);
  fetch(SPREADSHEET_URL, {
    method: "POST",
    mode: "no-cors",
    keepalive: true,
    body: formData,
    redirect: "follow"
  }).then(() => console.log("Skor terkirim"))
  .catch(err => console.error(err));
}

function restartQuiz() {
  document.getElementById("resultArea").classList.add("hidden");
  document.getElementById("questionArea").classList.remove("hidden");
  startQuiz();
}

function backToLogin() {
  document.getElementById("quizPage").classList.add("hidden");
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("userId").value = "";
  document.getElementById("kodeSoal").value = "";
}

document.getElementById("answerInput")?.addEventListener("keypress", e => {
  if (e.key === "Enter") submitAnswer();
});
</script>
</body>
</html>
